---
name: codex-cli-delegation
description: 코드 리뷰, 샌드박스 실행, 웹 검색+코딩 등 Codex CLI 특화 작업을 위임하는 패턴. PR 리뷰, 코드 실행 검증, 외부 정보 기반 코딩 작업 시 사용.
---

# Codex CLI 위임 패턴

## 1. 개요

### Codex CLI란?
OpenAI의 터미널 기반 AI 코딩 에이전트. 코드 리뷰, 샌드박스 실행, 웹 검색 연동 코딩이 가능하다.

### 왜 위임하는가?
- **코드 리뷰**: diff 기반 정밀 리뷰 + 자동 코멘트 생성
- **샌드박스 실행**: 격리된 환경에서 코드 실행 및 결과 검증
- **웹 검색 연동**: 최신 정보 검색과 코딩을 결합한 작업

### Gemini CLI와의 역할 분담

| 특성 | Gemini CLI | Codex CLI |
|------|-----------|-----------|
| 핵심 강점 | 대규모 컨텍스트 (1M+ 토큰) | 코드 리뷰, 샌드박스 실행 |
| 주요 용도 | 10+ 파일 분석, 아키텍처 파악 | PR 리뷰, 실행 테스트, 웹 검색 |
| 파일 수정 | 읽기 전용 분석 권장 | 샌드박스 내 실행 가능 |
| 실행 환경 | 네트워크 필요 | 로컬 샌드박스 + 네트워크 |

---

## 2. 사전 확인

### 설치 여부 확인
```bash
# macOS/Linux
which codex 2>/dev/null && echo "AVAILABLE" || echo "NOT_AVAILABLE"

# Windows
where codex 2>nul && echo "AVAILABLE" || echo "NOT_AVAILABLE"
```

### Fallback 전략
Codex CLI 미설치 시 Claude가 직접 수행:

| 원래 작업 | Fallback 방법 | 품질 영향 |
|----------|--------------|----------|
| 코드 리뷰 | `git diff` + `git log` 출력을 Claude가 직접 분석 | 낮음 (대부분 동등) |
| 샌드박스 실행 | 실행 불가, 코드 흐름 추적 및 설명만 제공 | 높음 (실행 검증 불가) |
| 웹 검색 + 코딩 | Claude의 WebSearch 도구 사용 | 낮음 (대부분 동등) |

---

## 3. 위임 판단 기준

### Codex CLI 위임 시나리오

| 시나리오 | 트리거 조건 | 예시 |
|---------|-----------|------|
| PR/커밋 코드 리뷰 | PR이나 커밋의 diff 리뷰 요청 | "최근 커밋 코드 리뷰해줘" |
| 코드 실행 검증 | 코드 변경 후 실행 결과 확인 필요 | "이 스크립트가 정상 실행되는지 확인해줘" |
| 웹 정보 기반 코딩 | 외부 API 문서/라이브러리 참조 필요 | "최신 Next.js 15 패턴으로 변경해줘" |
| 자동 버그 수정 | 간단한 버그의 자동 수정 | "이 테스트 실패 원인 찾아서 고쳐줘" |

### 위임하지 않는 경우
- 단일 파일의 간단한 수정
- Claude가 직접 수행 가능한 분석 작업
- 민감한 파일을 다루는 작업
- Codex CLI 미설치 환경

---

## 4. 명령어 패턴

### 승인 정책 (Approval Policy)

Codex CLI는 3단계 승인 정책을 제공합니다:

| 모드 | 플래그 | 설명 | 권장 사용 상황 |
|------|-------|------|---------------|
| **Suggest** | (기본값) | 모든 변경에 승인 필요 | 처음 사용 시, 민감 코드 |
| **Auto Edit** | `--auto-edit` | 파일 수정 자동, 명령 실행은 승인 | 코드 수정 작업 |
| **Full Auto** | `--full-auto` | 모든 작업 자동 승인 | 신뢰할 수 있는 반복 작업 |

> **주의**: `--full-auto`는 신뢰할 수 있는 작업에만 사용합니다.

### 기본 사용법

```bash
# 대화형 모드 (기본)
codex

# 비대화형 모드 (프롬프트 직접 전달)
codex "프롬프트 내용"

# 출력만 (quiet 모드)
codex -q "프롬프트 내용"

# 모델 지정
codex --model o4-mini "프롬프트 내용"
```

### 코드 리뷰 패턴

```bash
# 최근 커밋 리뷰
codex "최근 커밋의 코드 변경사항을 리뷰해줘. 버그, 보안 취약점, 코드 품질 문제를 지적해줘."

# 특정 커밋 리뷰
codex "다음 커밋을 리뷰해줘: $(git log --oneline -1 HEAD). 변경된 코드의 품질, 보안, 성능 이슈를 분석해줘."

# PR 리뷰 (GitHub CLI 연동)
codex "$(gh pr diff 123) 이 PR의 변경사항을 리뷰해줘. 주요 변경점과 개선 제안을 정리해줘."

# staged 변경 리뷰
codex "$(git diff --cached) 이 변경사항을 리뷰해줘. 커밋 전 검토 항목을 알려줘."
```

### 샌드박스 실행 패턴

```bash
# 읽기 전용 샌드박스 (네트워크 비활성)
codex --full-auto --sandbox read-only "tests/ 디렉토리의 테스트를 실행하고 결과를 알려줘"

# 네트워크 허용 샌드박스
codex --full-auto --sandbox network "이 API 엔드포인트를 호출하고 응답을 확인해줘"
```

### 웹 검색 연동 패턴

```bash
# 최신 문서 기반 코딩
codex "Next.js 15의 최신 Server Actions 패턴을 검색하고, 우리 프로젝트에 적용할 수 있는 코드를 작성해줘"

# 라이브러리 마이그레이션
codex "Pydantic v2 마이그레이션 가이드를 검색하고, backend/app/modules/ 에 적용할 변경점을 정리해줘"

# 보안 취약점 검색
codex "최신 FastAPI 보안 취약점 CVE를 검색하고, 우리 프로젝트에 해당하는 항목을 확인해줘"
```

### stdin 파이핑 패턴

```bash
# diff를 파이프로 전달
git diff HEAD~3..HEAD | codex "이 변경사항들의 코드 리뷰를 수행해줘"

# 특정 파일 내용 전달
cat backend/app/main.py | codex "이 파일의 개선점을 제안해줘"

# 테스트 결과 전달
uv run pytest --tb=short 2>&1 | codex "실패한 테스트의 원인을 분석하고 수정 방법을 제안해줘"
```

---

## 5. 결과 활용 방법

### 기본 흐름
1. Codex CLI로 리뷰/분석/실행 수행
2. 출력 결과를 Claude가 수신
3. **결과 검증** (파일 경로, 함수명 존재 여부 등)
4. 검증된 결과를 기반으로 코드 수정 또는 보고

### 코드 리뷰 결과 활용
```
1. Codex CLI 리뷰 결과 수신
2. 지적된 파일/라인 실제 존재 확인 (Read 도구)
3. 유효한 지적사항만 필터링
4. Claude가 실제 코드 수정 수행
5. 수정 후 검증 (lint, type check)
```

### 실행 결과 활용
```
1. Codex CLI 실행 결과 수신
2. 에러 발생 시 원인 분석
3. Claude가 수정 코드 작성
4. 수정 후 재검증 (가능한 경우)
```

---

## 6. 주의사항

### 보안 규칙
- **민감 파일 전달 금지**: `.env`, `credentials.json`, `*.pem`, `*.key` 등
- **API 키 노출 금지**: 환경 변수로 관리되는 비밀 값을 프롬프트에 포함하지 않음
- `--full-auto` 모드는 민감 코드 수정에 사용 금지

### 실행 규칙
- **읽기 전용 분석 우선**: 코드 수정은 Claude가 담당, Codex는 분석/리뷰 용도
- **샌드박스 모드 활용**: 실행이 필요한 경우 반드시 샌드박스 내에서 수행
- **네트워크 접근 최소화**: 필요한 경우에만 `--sandbox network` 사용

### 결과 검증 규칙
- Codex CLI 출력은 반드시 Claude가 검증 (오탐, 오류 가능)
- 존재하지 않는 파일/함수를 언급한 경우 제거
- 보안 취약점 지적은 실제 코드에서 재확인
- 수정 제안은 프로젝트 코딩 규칙(`coding-style.md`)에 맞는지 확인

### 에러 처리
```
1. Codex CLI 실행 실패 → Fallback으로 전환
2. 타임아웃 발생 → 작업 범위 축소 후 재시도
3. 네트워크 오류 → 로컬 분석으로 전환
4. 인증 실패 → 사용자에게 설정 확인 안내
```

---

## 7. Fallback 상세 패턴

### 코드 리뷰 Fallback

Codex CLI 없이 Claude가 직접 코드 리뷰를 수행하는 패턴:

```bash
# 1. 변경 내역 확인
git log --oneline -10
git diff HEAD~1..HEAD --stat
git diff HEAD~1..HEAD

# 2. 변경된 파일 읽기 (Read 도구 사용)
# 3. 변경 사항 분석 및 리뷰 코멘트 작성
```

### 웹 검색 Fallback

Codex CLI 없이 Claude의 WebSearch 도구로 대체:

```
1. WebSearch 도구로 관련 정보 검색
2. WebFetch 도구로 공식 문서 확인
3. 검색 결과를 기반으로 코드 작성
```

### 샌드박스 실행 Fallback

실행 불가 시 Claude가 제공하는 대안:

```
1. 코드 흐름을 정적으로 추적하여 예상 결과 설명
2. 잠재적 에러 지점 표시
3. 사용자에게 직접 실행 방법 안내
4. 필요 시 테스트 코드 작성으로 대체
```

---

## 8. Gemini CLI와의 병렬 사용

두 CLI를 함께 사용하는 패턴은 `.claude/skills/multi-cli-integration/SKILL.md` 참조.

### 간단한 조합 예시

| 시나리오 | Gemini CLI 역할 | Codex CLI 역할 | Claude 역할 |
|---------|----------------|---------------|------------|
| 보안 감사 | 전체 코드 스캔 | CVE 검색 | 결과 통합, 수정 |
| 리팩토링 | 아키텍처 분석 | 변경 후 리뷰 | 코드 작성 |
| PR 작성 | 영향 분석 | diff 리뷰 | PR 본문 작성 |
